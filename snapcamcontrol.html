<!DOCTYPE HTML> <html> <head> <!-- Copyright (c) 2019 David Imhoff <dimhoff.devel <at> gmail.com> This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA. --> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Control for iON SnapCamâ„¢</title> <style> #busyScreen{ z-index:1000;position:fixed;top:0;left:0;right:0;bottom:0;background:rgb(120, 120, 120, 50%);}#busyScreen > div:first-child{ position:absolute;height:150px;width:100%; top:0;left:0;bottom:0;right:0;margin:auto;}#busySpinner{ width:200px;height:125px;margin:auto;}#busySpinner div{ box-sizing:border-box;padding:10px;border-radius:50%;border-width:20px;border-style:solid;border-color:transparent; animation-duration:4s;animation-timing-function:ease-in;animation-iteration-count:infinite;} #busySpinner > div{ width:200px;height:200px;animation-name:lightup75;} #busySpinner > div > div{ animation-name:lightup50;} #busySpinner > div > div > div{ animation-name:lightup25;} #busySpinner > div > div > div > div{ padding:0px;border-color:black;border-width:10px;width:0px;height:0px;margin:auto;}@keyframes lightup25{ 5%{ border-top-color:transparent;}25%{ border-top-color:black;}90%{ border-top-color:black;}}@keyframes lightup50{ 25%{ border-top-color:transparent;}50%{ border-top-color:black;}90%{ border-top-color:black;}}@keyframes lightup75{ 50%{ border-top-color:transparent;}75%{ border-top-color:black;}90%{ border-top-color:black;}}#busyMsg{ width:100%;text-align:center;font-size:large;}#busyMsgTxt{ background-color:lightgrey;padding:1px 10px;border-radius:15px;}</style> <script>"use strict";function busyScreenInit(){if(document.getElementById("busyScreen")){throw new Error("It is only possible to construct one BusyScreen per document")}let busySpinnerEl=document.createElement("DIV");for(let i=0;i<4;i++){let parentEl=document.createElement("DIV");parentEl.appendChild(busySpinnerEl);busySpinnerEl=parentEl}busySpinnerEl.id="busySpinner";let busyMsgTxtEl=document.createElement("SPAN");busyMsgTxtEl.id="busyMsgTxt";let busyMsgEl=document.createElement("DIV");busyMsgEl.id="busyMsg";busyMsgEl.appendChild(busyMsgTxtEl);let centerBoxEl=document.createElement("DIV");centerBoxEl.appendChild(busySpinnerEl);centerBoxEl.appendChild(busyMsgEl);let busyScreenEl=document.createElement("DIV");busyScreenEl.id="busyScreen";busyScreenEl.style.display="none";busyScreenEl.appendChild(centerBoxEl);document.body.appendChild(busyScreenEl);document.busyScreen={show:function(msg=""){busyMsgTxtEl.innerText=msg;busyScreenEl.style.display="block"},setMsg:function(msg){busyMsgTxtEl.innerText=msg},hide:function(msg=""){busyScreenEl.style.display="none"}}}</script> <style> .hidden{ display:none;}#connectPage{ position:absolute;height:150px;width:150px; top:0;left:0;bottom:0;right:0;margin:auto;}#btnConnect{ width:100%;height:100%;border:2px solid black;border-radius:15%;}#btnConnectLens{ position:absolute;width:20px;height:20px;top:10px;right:10px;border:2px solid black;border-radius:50%;}#settingsPage{ max-width:600px;margin:auto;}#fsInfo label{ width:30px;display:inline-block;}#batteryDisplay{ margin:0px 2px;padding:1px;border:1px solid black;}#batteryDisplay span{ padding:0 5px;margin:1px;}#fsSettings label{ width:160px;display:inline-block;}#inpDeviceName{ width:21ex;}#fsSettings select{ width:150px;}#outLog{ background-color:lightgrey;overflow:auto;}#divCopyright{ position:fixed;bottom:0px;left:0px;margin:5px;border-radius:5px; width:1em;overflow:hidden;white-space:nowrap;transition:all 1s ease-in;}#divCopyright:hover{ width:600px;background-color:white;}#divCopyright A{ color:black;text-decoration:none;}</style> </head> <body> <div id="connectPage"> <button id="btnConnect"><div id="btnConnectLens"></div>Connect to SnapCamâ„¢</button> </div> <div id="settingsPage" class="hidden"> <form id="frmSettings" action="javascript:void(0);"> <button id="btnDisconnect">Disconnect</button> <fieldset id="fsInfo"> <legend>Info</legend> <div><label for="outProductVersion">V</label><output id="outProductVersion"></output></div> <div><label for="outStorageTotal">ðŸ“‚ </label><output id="outStorageTotal">?</output> MB -- <output id="outStorageFree">?</output> MB Free </div> <div><label>ðŸ”‹</label><span id="batteryDisplay"> <span></span> <span></span> <span></span> <span></span> <span></span> </span> </div> </fieldset> <fieldset id="fsSettings"> <legend>Settings</legend> <div><label for="inpDeviceName">Device Name: </label><input id="inpDeviceName" type="text" maxlength="20"></div> <div><label for="cbAutoRotation">Auto Rotation: </label><input id="cbAutoRotation" type="checkbox" checked></div> <div><label for="selPhotoRes">Photo Resolution: </label><select id="selPhotoRes"><option>2MP</option><option selected>8MP</option></select></div> <div><label for="selVideoRes">Video Resolution: </label><select id="selVideoRes"><option>WVGA</option><option selected>720p</option></select></div> <div><label for="selTimelapseIval">Timelapse: </label><select id="selTimelapseIval"><option value="10" selected>Every 10 Sec</option><option value="30">Every 30 Sec</option><option value="60">Every 60 Sec</option></select></div> <div><button id="btnSyncTime">Synchronize Device clock</button></div> </fieldset> <fieldset id="fsWifi"> <legend>WiFi</legend> <div><button id="btnEnableWifi">Enable Wifi</button></div> <div id="wifiInstructions" class="hidden"> <p>Instructions:</p> <ol> <li>Connect to WiFi access point</li> <ul> <li>SSID: <output id="outWifiSSID"></output></li> <li>Password: <output id="outWifiPass"></output></li> </ul> <li>Go to: <a id="lnkWifiPage" href target="_blank"></a></li> <li>When done disable WiFi by pushing the power button shortly on the device.</li> </ol> </div> </fieldset> <fieldset id="fsActions"> <legend>Actions</legend> <div><button id="btnTakeImage">Take Image</button><button id="btnTimelapse">Start Timelapse</button><button id="btnRecordVideo">Record Video</button></div> </fieldset> <fieldset id="fsDebug"> <legend>Debug</legend> <div><label for="cbEnableDebug">Enable Debug</label><input type="checkbox" id="cbEnableDebug"></div> <div id="divDebugItems" class="hidden"> <fieldset id="fsDebugRawCmd"> <legend>Raw command:</legend> <div><label for="inpRawCmd">Command: </label><input id="inpRawCmd" type="number" min="0"></div> <div><label for="inpRawArgs">Args: </label><input id="inpRawArgs" type="text" placeholder="JSON"></div> <div><label for="inpRawResponse">Expect Response: </label><input id="inpRawResponse" type="checkbox"></div> <div><button id="btnRawSend">Send</button></div> </fieldset> <p>Console:</p> <pre id="outLog" style="border:1px solid black;overflow:auto;height:100px;"></pre> </div> </fieldset> </form> </div><!-- end settingsPage --> <div id="divCopyright"> &copy; <span id="spnCopyrightText"> License: <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><!--img alt="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /-->CC BY-NC-SA 4.0</a> | Copyright 2019 David Imhoff | Version: 0.1 </span> </div><!-- end divCopyright --> <script>"use strict";busyScreenInit();const UUID_SERVICE="1b7e8251-2877-41c3-b46e-cf057c562023";const UUID_NOTIFY="8ac32d3f-5cb9-4d44-bec2-ee689169f626";const UUID_CMD="5e9bf2a8-f93f-4481-a67e-3b2f4a07891a";const MAX_FRAME_SIZE=20;const MAX_SEND_RETRY=3;const BLE_RESPONSE_TIMEOUT=5e3;const utf8Encoder=new TextEncoder("utf-8");const utf8Decoder=new TextDecoder("utf-8");const ackFrame=utf8Encoder.encode('{"ret":1}');var bleDevice=null;var cmdCharacteristic=null;var notifyCharacteristic=null;var bleResponseQueue=[];var deviceState=0;var disconnecting=false;function log(msg){const logOutput=document.getElementById("outLog");if(logOutput.textContent.length!=0){logOutput.textContent+="\n"}logOutput.textContent+=msg;logOutput.scrollTo(0,logOutput.scrollTopMax?logOutput.scrollTopMax:65535)}function buf2hex(buf){const convert=x=>("00"+x.toString(16)).slice(-2);if(buf instanceof DataView){return Array.prototype.map.call(new Uint8Array(buf.buffer,buf.byteOffset,buf.byteLength),convert).join("")}else if(buf instanceof ArrayBuffer){return Array.prototype.map.call(new Uint8Array(buf),convert).join("")}else{return Array.prototype.map.call(buf,convert).join("")}}function buf2asc(buf){const convert=x=>{if(x==92){return"\\\\"}else if(x>31&&x<127){return String.fromCodePoint(x)}else{return"\\x"+("00"+x.toString(16)).slice(-2)}};if(buf instanceof DataView){return Array.prototype.map.call(new Uint8Array(buf.buffer,buf.byteOffset,buf.byteLength),convert).join("")}else if(buf instanceof ArrayBuffer){return Array.prototype.map.call(new Uint8Array(buf),convert).join("")}else{return Array.prototype.map.call(buf,convert).join("")}}function handleBtnDisconnectClick(evt){disconnecting=true;bleDevice.gatt.disconnect()}async function handleBtnConnectClick(evt){let options={filters:[{services:[UUID_SERVICE]}]};if(!navigator.bluetooth){alert("The Bluetooth API is not supported in this browser.");return}try{log("Requesting Bluetooth Device...");try{bleDevice=await navigator.bluetooth.requestDevice(options)}catch(e){if(e instanceof DOMException&&e.name=="NotFoundError"){return}throw e}log("> Name:             "+bleDevice.name);log("> Id:               "+bleDevice.id);bleDevice.addEventListener("gattserverdisconnected",handleBleDisconnected);disconnecting=false;log("Connecting to GATT Server...");document.busyScreen.show("Connecting to "+bleDevice.name+"...");const server=await bleDevice.gatt.connect();log("Getting Service...");document.busyScreen.setMsg("Getting Service...");const service=await server.getPrimaryService(UUID_SERVICE);log("Getting Command Characteristic...");document.busyScreen.setMsg("Getting Command Characteristic...");cmdCharacteristic=await service.getCharacteristic(UUID_CMD);log("Getting Notification Characteristic...");document.busyScreen.setMsg("Getting Notification Characteristic...");notifyCharacteristic=await service.getCharacteristic(UUID_NOTIFY);log("Starting notifications...");document.busyScreen.setMsg("Starting notifications...");notifyCharacteristic.addEventListener("characteristicvaluechanged",handleNotificationChanged);await notifyCharacteristic.startNotifications();await updateInfo();document.getElementById("wifiInstructions").classList.add("hidden");document.getElementById("connectPage").classList.add("hidden");document.getElementById("settingsPage").classList.remove("hidden");log("Done!")}catch(e){console.log(e);alert("Failed to connect to device: "+e);if(bleDevice!=null&&bleDevice.gatt.connected){bleDevice.gatt.disconnect()}}finally{document.busyScreen.hide()}}async function updateInfo(){let response=null;log("Querying Device Name...");document.busyScreen.setMsg("Querying Device Name...");document.getElementById("inpDeviceName").value=bleDevice.name;log("Querying Product Version...");document.busyScreen.setMsg("Querying Product Version...");response=await sendCommand(25,{},true);document.getElementById("outProductVersion").value=response.ver;log("Querying Storage Info...");document.busyScreen.setMsg("Querying Storage Info...");response=await sendCommand(24,{},true);document.getElementById("outStorageTotal").value=parseInt(response.total,16);document.getElementById("outStorageFree").value=parseInt(response.free,16);log("Querying Battery Info...");document.busyScreen.setMsg("Querying Battery Info...");response=await sendCommand(27,{},true);setBatteryLevel(parseInt(response.battery))}function setBatteryLevel(lvl){const batteryDisplayEl=document.getElementById("batteryDisplay");const batteryParts=batteryDisplayEl.getElementsByTagName("SPAN");for(let i=0;i<batteryParts.length;i++){if(i<lvl){batteryParts[i].style.backgroundColor="green"}else{batteryParts[i].style.backgroundColor="initial"}}}function handleBleDisconnected(evt){if(!disconnecting){log("The device has disconnected");alert("The device has disconnected")}else{log("Successfully disconnected from device");disconnecting=false}document.getElementById("settingsPage").classList.add("hidden");document.getElementById("connectPage").classList.remove("hidden")}async function handleNotificationChanged(evt){let respBuf=evt.target.value;log("enqueue["+bleResponseQueue.length+"]: "+buf2asc(respBuf));bleResponseQueue.push(respBuf);document.dispatchEvent(new Event("bleNotificationReceived",{bubbles:false,cancelable:false}))}async function handleBtnTakeImageClick(evt){try{document.busyScreen.show("Taking image...");await sendCommand(14)}catch(e){log("Failed to Take Picture: "+e);alert("Failed to Take Picture: "+e)}finally{document.busyScreen.hide()}}async function handleBtnTimelapseClick(evt){const timelapseButton=document.getElementById("btnTimelapse");const recordButton=document.getElementById("btnRecordVideo");const photoButton=document.getElementById("btnTakeImage");try{if(deviceState==0){document.busyScreen.show("Starting Timelapse...");await sendCommand(12);timelapseButton.innerText="Stop Timelapse";photoButton.disabled=recordButton.disabled=true;deviceState=1}else{document.busyScreen.show("Stopping Timelapse...");await sendCommand(13);timelapseButton.innerText="Start Timelapse";photoButton.disabled=recordButton.disabled=false;deviceState=0}}catch(e){log("Failed to Toggle Timelapse: "+e);alert("Failed to Toggle Timelapse: "+e)}finally{document.busyScreen.hide()}}async function handleBtnRecordVideoClick(evt){const timelapseButton=document.getElementById("btnTimelapse");const recordButton=document.getElementById("btnRecordVideo");const photoButton=document.getElementById("btnTakeImage");try{if(deviceState==0){document.busyScreen.show("Starting Video...");await sendCommand(6);recordButton.innerText="Stop Video";photoButton.disabled=timelapseButton.disabled=true;deviceState=1}else{document.busyScreen.show("Stopping Video...");await sendCommand(7);recordButton.innerText="Start Video";photoButton.disabled=timelapseButton.disabled=false;deviceState=0}}catch(e){log("Failed to Toggle Video Recording: "+e);alert("Failed to Toggle Video Recording: "+e)}finally{document.busyScreen.hide()}}function handleCbEnableDebugClick(evt){const debugDiv=document.getElementById("divDebugItems");if(evt.target.checked){debugDiv.classList.remove("hidden")}else{debugDiv.classList.add("hidden")}}async function handleBtnRawSend(evt){try{document.busyScreen.show("Sending Raw Frame...");let argsValue=document.getElementById("inpRawArgs").value;if(argsValue.length==0){argsValue="{}"}const cmd=parseInt(document.getElementById("inpRawCmd").value);const args=JSON.parse(argsValue);const expectResponse=document.getElementById("inpRawResponse").checked;await sendCommand(cmd,args,expectResponse)}catch(e){log("Failed to execute Raw Send: "+e);alert("Failed to execute Raw Send: "+e)}finally{document.busyScreen.hide()}}async function handleInpDeviceNameChange(evt){const newName=evt.target.value;try{document.busyScreen.show("Changing Device Name...");await sendCommand(2,{Name:newName})}catch(e){log("Failed to set Device Name: "+e);alert("Failed to set Device Name: "+e)}finally{document.busyScreen.hide()}}async function handleCbAutoRotationChange(evt){const value=evt.target.checked?"On":"Off";try{document.busyScreen.show("Setting Auto Rotation...");await sendCommand(1,{AutoRotation:value})}catch(e){log("Failed to set Auto Rotation: "+e);alert("Failed to set Auto Rotation: "+e)}finally{document.busyScreen.hide()}}async function handleSelVideoResChange(evt){const value=evt.target.value;try{document.busyScreen.show("Setting Video Mode...");await sendCommand(4,{VideoMode:value})}catch(e){log("Failed to set Video Resolution: "+e);alert("Failed to set Video Resolution: "+e)}finally{document.busyScreen.hide()}}async function handleSelPhotoResChange(evt){const value=evt.target.value;try{document.busyScreen.show("Setting Photo Mode...");await sendCommand(5,{PhotoMode:value})}catch(e){log("Failed to set Photo Resolution: "+e);alert("Failed to set Photo Resolution: "+e)}finally{document.busyScreen.hide()}}async function handleSelTimelapseIvalChange(evt){const value=evt.target.value;try{document.busyScreen.show("Setting Timelapse Interval...");await sendCommand(11,{second:value})}catch(e){log("Failed to set Timelapse Interval: "+e);alert("Failed to set Timelapse Interval: "+e)}finally{document.busyScreen.hide()}}async function handleBtnSyncTimeClick(evt){try{document.busyScreen.show("Synchronizing device clock...");const pad=n=>n<10?"0"+n:n.toString();const now=new Date;const dateStr=now.getFullYear()+pad(now.getMonth()+1)+pad(now.getDate())+pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds());log("Setting time to: "+dateStr);await sendCommand(15,{time:dateStr})}catch(e){log("Failed to set Date/Time: "+e);alert("Failed to set Date/Time: "+e)}finally{document.busyScreen.hide()}}async function handleBtnEnableWifiClick(evt){let resp=null;try{log("Getting AP info...");document.busyScreen.show("Getting AP info...");resp=await sendCommand(18,{},true);document.getElementById("outWifiSSID").value=resp.ssid;document.getElementById("outWifiPass").value=resp.pwd;log("Getting IP address...");document.busyScreen.show("Getting IP address...");resp=await sendCommand(29,{},true);const lnkEl=document.getElementById("lnkWifiPage");lnkEl.innerText=lnkEl.href="http://"+resp.ip+"/";log("Enabling WiFi...");document.busyScreen.show("Enabling WiFi...");await sendCommand(22);document.getElementById("wifiInstructions").classList.remove("hidden")}catch(e){log("Failed to Enable WiFi: "+e);alert("Failed to Enable WiFi: "+e)}finally{document.busyScreen.hide()}}function makeCommandFrames(cmd,args){let cmdFields=Object.assign({},args);cmdFields["Type"]=cmd;const cmdJSON=JSON.stringify(cmdFields);const cmdBuf=utf8Encoder.encode(cmdJSON);const lenBuf=utf8Encoder.encode(cmdBuf.length.toString(16));let chksum=0;for(let b of cmdBuf){chksum+=b}chksum&=15;const frameBuf=new Uint8Array(1+lenBuf.length+cmdBuf.length+5);frameBuf[0]=255;frameBuf.set(lenBuf,1);frameBuf.set(cmdBuf,1+lenBuf.length);frameBuf.set(utf8Encoder.encode("CRC:"+chksum.toString(16)),1+lenBuf.length+cmdBuf.length);let frames=[];for(let i=0;i<frameBuf.length;i+=MAX_FRAME_SIZE){frames.push(frameBuf.subarray(i,i+MAX_FRAME_SIZE))}return frames}class BleTimeoutError extends Error{constructor(...params){super(...params);if(Error.captureStackTrace){Error.captureStackTrace(this,BleTimeoutError)}}}async function receiveResponse(){while(bleResponseQueue.length==0){await new Promise(function(resolve,reject){var cancelled=false;var timeoutId=setTimeout(function(){cancelled=true;reject(new BleTimeoutError("Timeout waiting for BLE response"))},BLE_RESPONSE_TIMEOUT);document.addEventListener("bleNotificationReceived",function(){if(!cancelled){clearTimeout(timeoutId);if(bleResponseQueue.length!=0){resolve()}}},{once:true})})}return bleResponseQueue.shift()}async function sendCommand(cmd,args={},expectResponse=false){const frames=makeCommandFrames(cmd,args);if(bleResponseQueue.length!=0){log("Response queue not empty! clearing");bleResponseQueue.length=0}for(let tryCnt=0;tryCnt<MAX_SEND_RETRY;tryCnt++){try{for(let frame of frames){log("< "+buf2asc(frame));await cmdCharacteristic.writeValue(frame);const response=await receiveResponse();log("> "+buf2asc(response))}log("queue cnt: "+bleResponseQueue.length);if(expectResponse){let frame=await receiveResponse();log("R> "+buf2asc(frame));if(frame.getUint8(0)!=255){throw new Error("Incorrect response!!! (start byte)")}let frameLen=NaN;let jsonOff=2;if(frame.getUint8(2)==123){jsonOff=2;frameLen=parseInt(utf8Decoder.decode(new DataView(frame.buffer,1,2)),16)}else if(frame.getUint8(3)==123){jsonOff=3;frameLen=parseInt(utf8Decoder.decode(new DataView(frame.buffer,1,3)),16)}if(frameLen==NaN){throw new Error("Incorrect response!!!(Frame length)")}let respStr=utf8Decoder.decode(new DataView(frame.buffer,jsonOff));while(respStr.length<frameLen+5){await cmdCharacteristic.writeValue(ackFrame);frame=await receiveResponse();log("R> "+buf2asc(frame));respStr+=utf8Decoder.decode(frame)}const crcStr=respStr.substring(respStr.length-5);if(!crcStr.startsWith("CRC:")){throw new Error("Incorrect response!!!(CRC-format)")}log("result: "+respStr.substring(0,respStr.length-5));return JSON.parse(respStr.substring(0,respStr.length-5))}else{return{ret:1}}}catch(e){if(!(e instanceof BleTimeoutError)){throw e}log("Retrying, try "+tryCnt+1)}}}document.getElementById("btnConnect").addEventListener("click",handleBtnConnectClick,false);document.getElementById("btnDisconnect").addEventListener("click",handleBtnDisconnectClick,false);document.getElementById("inpDeviceName").addEventListener("change",handleInpDeviceNameChange,false);document.getElementById("cbAutoRotation").addEventListener("change",handleCbAutoRotationChange,false);document.getElementById("selPhotoRes").addEventListener("change",handleSelPhotoResChange,false);document.getElementById("selVideoRes").addEventListener("change",handleSelVideoResChange,false);document.getElementById("selTimelapseIval").addEventListener("change",handleSelTimelapseIvalChange,false);document.getElementById("btnSyncTime").addEventListener("click",handleBtnSyncTimeClick,false);document.getElementById("btnEnableWifi").addEventListener("click",handleBtnEnableWifiClick,false);document.getElementById("btnTakeImage").addEventListener("click",handleBtnTakeImageClick,false);document.getElementById("btnTimelapse").addEventListener("click",handleBtnTimelapseClick,false);document.getElementById("btnRecordVideo").addEventListener("click",handleBtnRecordVideoClick,false);document.getElementById("cbEnableDebug").addEventListener("click",handleCbEnableDebugClick,false);document.getElementById("btnRawSend").addEventListener("click",handleBtnRawSend,false);document.getElementById("frmSettings").reset();</script> </body> </html> 
